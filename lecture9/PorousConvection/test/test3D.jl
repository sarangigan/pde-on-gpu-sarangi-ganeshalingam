using PorousConvection
using Test

include("../scripts/porous_convection_3D_xpu.jl")

# test scale
nx = 30
ny = 10
nz = 10
nt = 10

T = porous_convection_3D(nx = nx, ny = ny, nz = nz, nt = nt)

# a unit test
@testset "PorousConvection.jl" begin
    # Write your tests here.
    B = [2,4,6,8,10]
    @test av1(B) ≈ [3,5,7,9]
end


# a reference test:

xinds = [5, 9, 12, 13, 22]
yinds = [4, 5,  6,  7,  8]
zinds = [4, 5,  6,  7,  8]

ref_T = [0.986143700848918 0.9852616797154765 0.9852616797154773 0.98614370084892 0.9885336923083864; 0.9377793979726294 0.9383616396865716 0.9383616396865735 0.9377793979726344 0.9489764712654791; 1.2102521781932785 2.2224616473919587 2.222461647391963 1.2102521781932798 0.9504423948527254; 2.2055327087034464 6.614184392958237 6.614184392958251 2.2055327087034473 1.0831343368310535; 0.9377793979726321 0.938361639686572 0.938361639686574 0.9377793979726354 0.9489764712654798;;; 0.1170973529493675 0.11748558848204815 0.11748558848204885 0.11709735294936949 0.11851697527267552; 0.08224895826970278 0.10577617121389804 0.10577617121390287 0.08224895826972135 0.10418570973160518; 0.35233888806227415 0.9302347102888976 0.9302347102888999 0.35233888806227515 0.14828241568472073; 0.9598956088243592 3.186755182591123 3.186755182591128 0.9598956088243589 0.26422926746491465; 0.08224895826971361 0.10577617121389653 0.10577617121390354 0.0822489582697245 0.10418570973160578;;; -0.1332715646044954 -0.12872303733966703 -0.128723037339664 -0.13327156460448406 -0.1268752143883797; -0.45023544874606397 -0.2000947908637637 -0.20009479086372592 -0.4502354487458881 -0.18587649223510772; 0.072278864635832 0.4453708611449579 0.4453708611449597 0.07227886463583277 -0.13680680989279964; 0.49740200534845663 1.6950114349210854 1.6950114349210872 0.49740200534845436 -0.011347762682227935; -0.4502354487459541 -0.20009479086378135 -0.20009479086372073 -0.4502354487458572 -0.1858764922351042;;; -1.0433383582160984 -1.0168822175519057 -1.0168822175518928 -1.0433383582160438 -1.0125500755442987; -3.4681117297621338 -1.4155850106721988 -1.4155850106719718 -3.4681117297611226 -1.3093873048578697; -0.890646677649472 -0.6263576633377401 -0.6263576633377383 -0.890646677649474 -1.2753511748363149; -0.5934690858227677 0.12688189222098512 0.12688189222098556 -0.5934690858227754 -1.0410155576354034; -3.468111729761455 -1.4155850106723402 -1.4155850106719328 -3.468111729760931 -1.3093873048578473;;; -6.227045643841526 -6.118114214793018 -6.11811421479299 -6.2270456438413655 -6.129967193246692; -15.36066611286649 -7.541292927958467 -7.541292927957871 -15.360666112864077 -7.18795088177839; -5.952394872456619 -5.6497857113348005 -5.6497857113348005 -5.95239487245663 -7.106028547020567; -5.637799128947901 -5.035437913457626 -5.035437913457625 -5.637799128947918 -6.395677141194396; -15.360666112864777 -7.5412929279589465 -7.541292927957728 -15.360666112863582 -7.187950881778336]

@test all(ref_T  .≈ T[xinds, yinds, zinds])